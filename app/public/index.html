<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Telegram Login Example</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 50vh;
    }
    .login-container {
      text-align: center;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      background-color: #f9f9f9;
      margin-bottom: 20px;
    }
    h1 {
      color: #0088cc;
    }
    .instructions {
      text-align: left;
      margin-top: 30px;
    }
    pre {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .button {
      display: inline-block;
      background-color: #0088cc;
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      text-decoration: none;
      margin-top: 20px;
      cursor: pointer;
    }
    .button:hover {
      background-color: #006699;
    }
    .user-info {
      margin-top: 20px;
      padding: 15px;
      background-color: #f0f0f0;
      border-radius: 4px;
      text-align: left;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Telegram Login Example</h1>
    
    <div class="login-container">
      <h2>Login with Telegram</h2>
      <!-- 
        Login button injected by Telegram
        - data-telegram-login: Your bot username (no "@")
        - data-size: small | medium | large
        - data-userpic: show avatar? (true/false)
        - data-radius: rounded corners (pixels)
        - data-request-access: let bot DM the user (write)
      -->
      <div id="login-widget">
        <script async src="https://telegram.org/js/telegram-widget.js?21"
                data-telegram-login="eric_spider_bot"
                data-size="large"
                data-userpic="false"
                data-radius="8"
                data-request-access="write"
                data-onauth="onTelegramAuth">
        </script>
      </div>
      
      <div id="user-info" class="user-info">
        <h3>Logged in User:</h3>
        <pre id="user-data">Not logged in</pre>
        <a href="/app" class="button">Go to Dashboard</a>
        <button id="logout-button" class="button">Logout</button>
      </div>

      <script>
      // Check if user is already logged in and redirect to /app
      document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('auth_token');
        if (token) {
          // Redirect to the protected page
          window.location.href = '/app';
        }
      });
      
      function onTelegramAuth(user) {
        /* user = {
             id, first_name, last_name, username,
             photo_url, auth_date, hash
           } */
        console.log('Telegram auth successful:', user);
        
        fetch('/auth/telegram', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(user)
        })
        .then(r => r.json())
        .then(({ok, jwt}) => {
          if (ok) {
            console.log('Server authentication successful');
            // Store JWT in localStorage or cookies
            localStorage.setItem('auth_token', jwt);
            // Redirect to app
            location.replace('/app');
          } else {
            console.error('Server authentication failed');
            alert('Authentication failed. Please try again.');
          }
        })
        .catch(err => {
          console.error('Error during authentication:', err);
          alert('Authentication error. Please try again.');
        });
      }
      </script>
    </div>
    
    <div class="instructions">
      <h3>How to set up:</h3>
      <ol>
        <li>✅ Bot username is set to <code>eric_spider_bot</code></li>
        <li>✅ Domain configured with ngrok</li>
        <li>✅ Bot token set in the .env file</li>
        <li>✅ Server running at <code>http://localhost:3000</code></li>
      </ol>
    </div>
  </div>
</body>
</html>