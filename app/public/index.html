<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Telegram Login Example</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 50vh;
    }
    .login-container {
      text-align: center;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      background-color: #f9f9f9;
      margin-bottom: 20px;
      width: 100%;
      max-width: 600px;
    }
    h1 {
      color: #0088cc;
    }
    .instructions {
      text-align: left;
      margin-top: 30px;
    }
    pre {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .button {
      display: inline-block;
      background-color: #0088cc;
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      text-decoration: none;
      margin-top: 20px;
      cursor: pointer;
    }
    .button:hover {
      background-color: #006699;
    }
    .user-info {
      margin-top: 20px;
      padding: 15px;
      background-color: #f0f0f0;
      border-radius: 4px;
      text-align: left;
      display: none;
    }
    #debug-info {
      margin-top: 20px;
      padding: 15px;
      background-color: #ffe0e0;
      border-radius: 4px;
      text-align: left;
      width: 100%;
    }
    .error-message {
      color: #d9534f;
      background-color: #f9f2f2;
      border: 1px solid #d9534f;
      border-radius: 4px;
      padding: 10px;
      margin: 10px 0;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Telegram Login Example</h1>
    
    <div class="login-container">
      <h2>Login with Telegram</h2>
      
      <div id="error-container" class="error-message"></div>
      
      <!-- 
        Login button injected by Telegram
        - data-telegram-login: Your bot username (no "@")
        - data-size: small | medium | large
        - data-userpic: show avatar? (true/false)
        - data-radius: rounded corners (pixels)
        - data-request-access: let bot DM the user (write)
      -->
      <div id="login-widget">
        <script async src="https://telegram.org/js/telegram-widget.js?21"
                data-telegram-login="eric_spider_bot"
                data-size="large"
                data-userpic="false"
                data-radius="8"
                data-request-access="write"
                data-onauth="onTelegramAuth">
        </script>
      </div>
      
      <div id="user-info" class="user-info">
        <h3>Logged in User:</h3>
        <pre id="user-data">Not logged in</pre>
        <a href="app.html" class="button">Go to Dashboard</a>
        <button id="logout-button" class="button">Logout</button>
      </div>

      <div id="debug-info">
        <h3>Debug Information:</h3>
        <pre id="debug-data">No debug info yet</pre>
        <button id="manual-redirect" class="button">Manually Go to Dashboard</button>
      </div>

      <script>
      // Debug function
      function updateDebugInfo(message) {
        const debugData = document.getElementById('debug-data');
        const timestamp = new Date().toISOString();
        debugData.textContent += `\n[${timestamp}] ${message}`;
      }

      // Show error message
      function showError(message) {
        const errorContainer = document.getElementById('error-container');
        errorContainer.textContent = message;
        errorContainer.style.display = 'block';
        updateDebugInfo(`ERROR: ${message}`);
      }

      // Check if user is already logged in and redirect to app.html
      document.addEventListener('DOMContentLoaded', function() {
        updateDebugInfo('Page loaded, checking for token...');
        const token = localStorage.getItem('auth_token');
        if (token) {
          updateDebugInfo('Token found, redirecting to app.html...');
          // Redirect to the protected page
          window.location.href = 'app.html';
        } else {
          updateDebugInfo('No token found, staying on login page');
        }

        // Add manual redirect button handler
        document.getElementById('manual-redirect').addEventListener('click', function() {
          updateDebugInfo('Manual redirect button clicked');
          window.location.href = 'app.html';
        });
      });
      
      function onTelegramAuth(user) {
        try {
          /* user = {
               id, first_name, last_name, username,
               photo_url, auth_date, hash
             } */
          updateDebugInfo('Telegram auth successful: ' + JSON.stringify(user));
          
          // Store user data in localStorage
          localStorage.setItem('auth_token', JSON.stringify(user));
          updateDebugInfo('User data stored in localStorage');
          
          // Redirect directly to app.html without server verification
          updateDebugInfo('Redirecting to app.html...');
          setTimeout(() => {
            window.location.href = 'app.html';
          }, 1000); // Small delay to ensure debug info is visible
        } catch (error) {
          updateDebugInfo('Error in onTelegramAuth: ' + error.message);
          showError('Authentication error: ' + error.message);
        }
      }

      // Add logout functionality
      document.getElementById('logout-button').addEventListener('click', function() {
        localStorage.removeItem('auth_token');
        updateDebugInfo('Logged out, token removed from localStorage');
        document.getElementById('user-info').style.display = 'none';
        document.getElementById('login-widget').style.display = 'block';
        document.getElementById('error-container').style.display = 'none';
      });
      </script>
    </div>
    
    <div class="instructions">
      <h3>How to set up:</h3>
      <ol>
        <li>✅ Bot username is set to <code>eric_spider_bot</code></li>
        <li>✅ Domain configured with ngrok or Vercel</li>
        <li>✅ Bot token set in the .env file</li>
      </ol>
    </div>
  </div>
</body>
</html>